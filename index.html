<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <!-- user-scalable=no muhim -->
    <title>Mening AR Bino Turim</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <!-- NippleJS kutubxonasini qo'shish -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    
    <style>
        /* ... (oldingi stillaringiz) ... */

        model-viewer {
            width: 100%;
            height: 500px;
            background-color: #e8e8e8;
            border-radius: 8px;
            border: 1px solid #ddd;
            position: relative; /* Joystikni joylashtirish uchun */
        }

        /* Joystik uchun konteyner */
        #joystick-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px; /* Joystik o'lchami */
            height: 150px;
            opacity: 0.7;
            z-index: 10; /* Model-viewer ustida bo'lishi uchun */
        }

        /* AR Rejimida joystikni yashirish */
        model-viewer[ar-status="session-started"] ~ #joystick-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Binomni ARda Ko'ring!</h1>
        <p>Quyidagi 3D modelni aylantirib ko'rishingiz va AR tugmasini bosib, uni o'z atrofingizda jonlantirishingiz mumkin. 3D rejimida harakatlanish uchun joystikdan foydalaning (AR rejimida joystik yashiriladi).</p>

        <model-viewer 
            id="my-building-model"
            src="untitled.glb"
            alt="Mening bino modelim"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls <!-- Buni o'chirib qo'yish mumkin, agar faqat joystik bilan boshqarmoqchi bo'lsangiz -->
            environment-image="neutral"
            shadow-intensity="1.2"
            disable-pan <!-- Joystik bilan ishlaganda pan (siljitish)ni o'chirish foydali bo'lishi mumkin -->
            style="width: 100%; height: 500px;">
            
            <button slot="ar-button" id="ar-button" style="display: none;"></button>
            <div class="progress-bar" slot="progress-bar">
                <div class="update-bar"></div>
            </div>
        </model-viewer>

        <!-- Joystik uchun konteyner -->
        <div id="joystick-container"></div>

        <p>Agar AR tugmasi ko'rinmasa, qurilmangiz yoki brauzeringiz WebAR'ni qo'llab-quvvatlamasligi mumkin.</p>
    </div>

    <div class="footer">
        <!-- ... (footer qismi) ... -->
    </div>

    <script>
        const modelViewer = document.getElementById('my-building-model');
        const joystickContainer = document.getElementById('joystick-container');
        let joystick = null;

        const movementSpeed = 0.03; // Harakat tezligi (o'zgartirishingiz mumkin)
        const rotationSpeed = 0.02; // Aylanish tezligi (o'zgartirishingiz mumkin)

        // Model yuklangandan keyin joystikni sozlash
        modelViewer.addEventListener('load', () => {
            console.log('Model loaded');

            // Agar AR rejimida bo'lmasak joystikni yaratamiz
            if (!modelViewer.arActive) {
                createJoystick();
            }
        });

        function createJoystick() {
            if (joystick) {
                joystick.destroy(); // Eskisini yo'q qilish
            }
            const options = {
                zone: joystickContainer,
                mode: 'static', // Yoki 'dynamic' yoki 'semi'
                position: { left: '50%', top: '50%' },
                color: 'blue',
                size: 120
            };
            joystick = nipplejs.create(options);

            joystick.on('move', function (evt, data) {
                if (modelViewer.arActive) return; // AR rejimida harakatlanmaymiz

                const angle = data.angle.radian;
                const force = data.force > 1 ? 1 : data.force; // Kuchni chegaralash

                // Kamera orbitasini (pozitsiyasini) o'zgartirish
                // Bu oddiy yondashuv, yanada murakkabroq "first-person" kamera uchun
                // `cameraTarget` ni ham o'zgartirish va kamerani oldinga/orqaga siljitish kerak bo'ladi.
                
                // Oldinga/orqaga harakat (joystik vertikal harakati)
                // Bu qism ancha murakkab, chunki model-viewer kamerasi orbitada aylanadi.
                // Oddiy "cameraTarget"ni o'zgartirish bilan birinchi shaxs kamerasi qilish qiyin.
                // Hozircha faqat model atrofida aylanishni va yaqinlashishni ko'rsatamiz.

                // Model atrofida aylanish (joystik gorizontal harakati)
                // Bu `cameraOrbit`ni to'g'ridan-to'g'ri o'zgartirish bilan yaxshi ishlamaydi.
                // Buning o'rniga `camera-controls` ni vaqtincha o'chirib,
                // kamera orbitasini matematik hisoblashlar bilan boshqarish kerak.
                // Yoki, `camera-controls` ni yoqiq qoldirib, joystik faqat qo'shimcha
                // nozik sozlamalar uchun ishlatilishi mumkin.

                // Oddiyroq yondashuv: Joystik bilan modelni aylantirish (bu kamera harakati emas)
                // modelViewer.style.transform = `rotateY(${angle * (180/Math.PI)}deg)`; // Bu noto'g'ri usul

                // Eng yaxshi yondashuvlardan biri - model-viewerning o'z kamera API'sidan foydalanish.
                // Ammo "first-person walk" uchun bu API cheklangan.
                
                // Agar siz oddiyroq "orbitada aylanish"ni xohlasangiz:
                let [yaw, pitch, radius] = modelViewer.getCameraOrbit().split(" ").map(Number);
                
                // Joystikning gorizontal harakati bilan YAW (gorizontal aylanish)
                // Bu yerda `data.vector.x` ni ishlatamiz.
                const deltaYaw = -data.vector.x * rotationSpeed * force * 100; // Koeffitsientni sozlang
                modelViewer.cameraOrbit = `${yaw + deltaYaw}deg ${pitch}deg ${radius}m`;

                // Joystikning vertikal harakati bilan PITCH (vertikal aylanish) yoki RADIUS (yaqinlashish)
                // Radius (yaqinlashish/uzoqlashish)
                const deltaRadius = -data.vector.y * movementSpeed * force;
                let newRadius = radius + deltaRadius;
                if (newRadius < 0.5) newRadius = 0.5; // Minimal radius
                if (newRadius > 10) newRadius = 10;  // Maksimal radius
                modelViewer.cameraOrbit = `${yaw + deltaRadius}deg ${pitch}deg ${newRadius}m`;


                // Birinchi shaxs kamerasi uchun ancha murakkab mantiq kerak:
                // 1. Kameraning joriy yo'nalishini olish.
                // 2. Shu yo'nalish bo'yicha `cameraTarget` va kamera pozitsiyasini siljitish.
                // `modelViewer.getCameraDirection()` yordam berishi mumkin, lekin u faqat yo'nalish vektorini beradi.

                console.log('Joystick move:', data.vector.x, data.vector.y);
            });

            joystick.on('end', function () {
                // Joystik qo'yib yuborilganda
            });
        }

        // AR rejimiga kirganda/chiqqanda joystikni boshqarish
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                console.log('AR session started');
                if (joystick) joystick.destroy(); // ARda joystikni yashirish/o'chirish
                joystickContainer.style.display = 'none';
            } else if (event.detail.status === 'not-presenting') {
                console.log('AR session ended or not started');
                joystickContainer.style.display = 'block';
                if (!joystick && modelViewer.loaded) { // Faqat model yuklangan bo'lsa qayta yaratamiz
                     // createJoystick(); // Agar ar dan chiqqanda qayta paydo bo'lishini xohlasangiz
                }
            }
        });
        
        // Dastlab joystikni yashirib turish, agar AR birinchi bo'lib ishga tushsa
        if (modelViewer.arActive) {
            joystickContainer.style.display = 'none';
        }

    </script>
</body>
</html>
