<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Bino Turi (Doimiy Nazorat)</title>
    <meta name="description" content="A-Frame AR - untitled2.glb">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="aframe-v1.5.0.min.js"></script> <!-- Lokal A-Frame -->

    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        a-scene { height: 100vh; width: 100vw; }

        .ui-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
            padding: 0 10px;
            box-sizing: border-box;
            /* AR rejimida ham ko'rinib turishi uchun display:none olib tashlandi */
        }
        .ui-controls div { display: flex; gap: 8px; }
        .ui-controls button {
            padding: 12px 15px; font-size: 16px; background-color: rgba(0,0,0,0.65);
            color: white; border: none; border-radius: 8px; cursor: pointer;
            min-width: 50px; text-align: center;
        }
        .ui-controls button:active { background-color: rgba(0,0,0,0.85); }

        #ar-status-message-div {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1; visibility: hidden; background-color: rgba(0,0,0,0.7);
            color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;
        }
    </style>
</head>
<body>
    <a-scene
        webxr="optionalFeatures: dom-overlay, hit-test;"
        ar-mode-ui="enabled: true; overlayElement: #ar-status-message-div;"
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        background="color: #E0E0E0"
        id="myScene">

        <a-assets timeout="60000">
            <a-asset-item id="buildingAsset" src="untitled2.glb"></a-asset-item>
        </a-assets>

        <!-- Kamera Rig (O'yinchi) -->
        <a-entity id="playerRig" position="0 0.5 3"
                  wasd-controls="fly: true; acceleration: 30; enabled: true;" <!-- enabled: true doimiy -->
                  look-controls="pointerLockEnabled: true; magicWindowTrackingEnabled: false; touchEnabled: true; mouseEnabled: true; enabled: true;"> <!-- enabled: true doimiy -->
            <a-entity id="camera" camera="active: true" position="0 1.6 0">
            </a-entity>
        </a-entity>

        <!-- Sizning GLB modelingiz -->
        <a-gltf-model
            src="#buildingAsset"
            id="mainBuilding"
            position="0 0 0"
            scale="0.5 0.5 0.5"
            animation-mixer
            visible="true">
        </a-gltf-model>

        <a-plane id="groundPlane" position="0 -0.01 0" rotation="-90 0 0" width="100" height="100"
                 color="#B0B0B0" visible="true"></a-plane>

        <a-light type="ambient" color="#FFF" intensity="0.9"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.6" position="-1.5 3 2"></a-light>

    </a-scene>

    <div class="ui-controls">
        <div>
            <button id="btnHeightUp">▲ Baland</button>
            <button id="btnHeightDown">▼ Past</button>
        </div>
        <div>
            <button id="btnScaleUp">➕ Kattalas</button>
            <button id="btnScaleDown">➖ Kichrayt</button>
        </div>
    </div>

    <div id="ar-status-message-div">
        <span id="ar-status-message">AR rejimiga tayyor.</span>
    </div>

    <script>
        const scene = document.getElementById('myScene');
        const playerRig = document.getElementById('playerRig');
        const buildingModel = document.getElementById('mainBuilding');
        
        const btnHeightUp = document.getElementById('btnHeightUp');
        const btnHeightDown = document.getElementById('btnHeightDown');
        const btnScaleUp = document.getElementById('btnScaleUp');
        const btnScaleDown = document.getElementById('btnScaleDown');
        const arStatusDiv = document.getElementById('ar-status-message-div');
        const arStatusMsg = document.getElementById('ar-status-message');

        const PLAYER_RIG_HEIGHT_STEP = 0.2;
        const MODEL_SCALE_STEP = 0.05;
        const MIN_SCALE = 0.01;
        const MIN_PLAYER_RIG_Y = -10;

        scene.addEventListener('loaded', function () {
            console.log('A-Frame sahnasi yuklandi.');
            if (arStatusMsg) arStatusMsg.textContent = "Sahna yuklandi. ARga tayyor.";

            buildingModel.addEventListener('model-loaded', function () {
                console.log('GLB model yuklandi.');
                if (arStatusMsg && !scene.is('ar-mode')) {
                    arStatusMsg.textContent = "Model yuklandi. ARga tayyor.";
                }
            });
            buildingModel.addEventListener('model-error', function (e) {
                console.error('GLB model yuklashda xatolik:', e.detail.src);
                if (arStatusDiv) arStatusDiv.style.visibility = 'visible';
                if (arStatusMsg) arStatusMsg.textContent = "XATOLIK: Model fayli yuklanmadi!";
            });

            // AR rejimi hodisalari (nazoratni o'chirmaymiz)
            scene.addEventListener('enter-vr', function () {
                if (scene.is('ar-mode')) {
                    console.log("AR rejimiga kirildi!");
                    if (arStatusDiv) arStatusDiv.style.visibility = 'visible';
                    if (arStatusMsg) arStatusMsg.textContent = "AR Rejimida.";
                    // Nazoratni o'chirish qismi olib tashlandi
                    // playerRig.setAttribute('wasd-controls', 'enabled', false); // ENDI BU QATOR YO'Q
                    // playerRig.setAttribute('look-controls', 'enabled', false); // ENDI BU QATOR YO'Q
                    // playerRig.components['look-controls']?.pause();             // ENDI BU QATOR YO'Q
                }
            });

            scene.addEventListener('exit-vr', function () {
                console.log("AR rejimidan chiqildi!");
                if (arStatusDiv) arStatusDiv.style.visibility = 'hidden';
                // Nazoratni qayta yoqish qismi ham kerak emas, chunki u o'chirilmagan edi
                // playerRig.setAttribute('wasd-controls', 'enabled', true);
                // playerRig.setAttribute('look-controls', 'enabled', true);
                // playerRig.components['look-controls']?.play();
            });

            // Balandlikni sozlash
            btnHeightUp.addEventListener('click', () => {
                const currentPos = playerRig.getAttribute('position');
                playerRig.setAttribute('position', { x: currentPos.x, y: currentPos.y + PLAYER_RIG_HEIGHT_STEP, z: currentPos.z });
            });
            btnHeightDown.addEventListener('click', () => {
                const currentPos = playerRig.getAttribute('position');
                let newY = currentPos.y - PLAYER_RIG_HEIGHT_STEP;
                if (newY < MIN_PLAYER_RIG_Y) newY = MIN_PLAYER_RIG_Y;
                playerRig.setAttribute('position', { x: currentPos.x, y: newY, z: currentPos.z });
            });

            // Model masshtabini sozlash
            btnScaleUp.addEventListener('click', () => {
                const currentScale = buildingModel.getAttribute('scale');
                buildingModel.setAttribute('scale', { 
                    x: currentScale.x + MODEL_SCALE_STEP, 
                    y: currentScale.y + MODEL_SCALE_STEP, 
                    z: currentScale.z + MODEL_SCALE_STEP 
                });
            });
            btnScaleDown.addEventListener('click', () => {
                const currentScale = buildingModel.getAttribute('scale');
                let newS = currentScale.x - MODEL_SCALE_STEP;
                if (newS < MIN_SCALE) newS = MIN_SCALE;
                buildingModel.setAttribute('scale', { x: newS, y: newS, z: newS });
            });
        });
    </script>
</body>
</html>
